{% extends "base.html" %}
{% block content %}

<style>
    /* TWOJE STYLE - BEZ ZMIAN */
    .logged-badge {
        position: absolute;
        top: 25px;
        left: 30px;
        background: #fdfaf0;
        border: 1px solid #af8c4b;
        color: #5d4a27;
        padding: 5px 12px;
        border-radius: 6px;
        font-family: 'Georgia', serif;
        font-size: 0.8em;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .carousel-container {
        position: relative;
        max-width: 1100px;
        margin: 0 auto 80px auto;
        padding: 0 50px;
        display: flex;
        align-items: center;
    }

    .book-carousel {
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        gap: 30px;
        padding: 20px 5px;
        scrollbar-width: none;
        -ms-overflow-style: none;
        scroll-behavior: smooth;
        width: 100%;
    }

    .book-carousel::-webkit-scrollbar { display: none; }

    .book-carousel .card {
        flex: 0 0 calc(25% - 23px);
        scroll-snap-align: start;
        transition: transform 0.3s ease;
        margin-bottom: 10px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center; 
        text-align: center;
    }

    .book-carousel .card:hover { transform: translateY(-5px); }

    .book-carousel .card img {
        width: 100%;
        height: auto;
        aspect-ratio: 2/3;
        object-fit: cover;
        border-radius: 15px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .book-carousel h3 {
        margin: 15px 0 5px 0;
        font-family: 'Georgia', serif;
        font-size: 1.1em;
        color: #5d4a27;
    }

    .book-carousel p {
        margin: 0;
        font-family: 'Georgia', serif;
        font-size: 0.9em;
        color: #af8c4b;
    }

    .nav-btn {
        background: none;
        border: none;
        color: #af8c4b;
        font-size: 2em;
        cursor: pointer;
        padding: 10px;
        z-index: 10;
    }

    .modal-overlay {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
    }

    .modal-box {
        background-color: #fff;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        border-radius: 20px;
        width: 95%;
        max-width: 450px; 
        max-height: 85vh;
        overflow-y: auto;
        font-family: 'Georgia', serif;
        box-shadow: 0 15px 40px rgba(0,0,0,0.2); 
        border: 1px solid #f2e6c9;
    }

    #modal-title { color: #5d4a27; font-size: 1.4em; margin-bottom: 5px; text-align: center; }
    #modal-author { color: #af8c4b; font-size: 1em; font-style: italic; text-align: center; margin-bottom: 20px; font-weight: normal; }
    #modal-desc { line-height: 1.6; color: #444; font-size: 0.9em; text-align: justify; padding: 0 10px; }
    #modal-img { display: block; margin: 0 auto 20px auto; width: 130px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

    .modal-box::-webkit-scrollbar { width: 4px; }
    .modal-box::-webkit-scrollbar-thumb { background: #f2e6c9; border-radius: 10px; }
    .close-btn { position: absolute; right: 20px; top: 15px; font-size: 30px; cursor: pointer; color: #af8c4b; }
    .comment-bubble { background: #fdfaf0; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #af8c4b; }
</style>

{% if session.get('user_id') %}
<div class="logged-badge">
    <strong>Zalogowano:</strong> {{ session['user'] }}
</div>
{% endif %}

<div style="text-align: center; margin-bottom: 50px; margin-top: 50px; overflow: hidden;">
    <div style="max-width: 100%; margin: 0 auto;">
        <img src="{{ url_for('static', filename='tlo.png') }}" alt="Sandi's Book Club" 
             style="width: 100%; max-height: 500px; object-fit: cover;">
    </div>
    <p style="margin-top: 25px; font-family: 'Georgia', serif; font-style: italic; color: #5d4a27; font-size: 1.1em; max-width: 700px; margin-left: auto; margin-right: auto;">
        Kameralny klub czytelniczy dla tych, którzy szukają sensu, emocji i rozmów bez pośpiechu.
    </p>
</div>

<div id="countdown-section" style="text-align: center; margin: 50px 0; padding: 35px; background: #fcf6e8; border-radius: 15px; border: 1px solid #f2e6c9;">
    <h3 style="font-family: 'Georgia', serif; color: #af8c4b; text-transform: uppercase; letter-spacing: 2px; font-size: 0.9em;">Następne spotkanie klubu za:</h3>
    <div id="timer" style="font-family: 'Georgia', serif; color: #5d4a27; font-size: 3.5em; font-weight: bold; display: flex; justify-content: center; gap: 25px;">
        <div><span id="days">00</span><small style="display:block; font-size: 0.3em;">Dni</small></div>
        <div><span id="hours">00</span><small style="display:block; font-size: 0.3em;">Godz</small></div>
        <div><span id="minutes">00</span><small style="display:block; font-size: 0.3em;">Min</small></div>
        <div><span id="seconds">00</span><small style="display:block; font-size: 0.3em;">Sek</small></div>
    </div>
</div>

<hr style="border: 0; border-top: 1px solid #f2e6c9; margin: 60px 0;">

<h2 style="text-align: center; color: #5d4a27; margin-bottom: 30px; font-family: 'Georgia', serif; font-size: 2em;">
    <span style="border-bottom: 2px solid #af8c4b; padding-bottom: 10px;">Omawiane teraz</span>
</h2>

<div class="carousel-container">
    <button class="nav-btn" onclick="scrollC('discussed-c', -300)">❮</button>
    <div class="book-carousel" id="discussed-c">
        {% for b in discussed %}
        <div class="card" onclick="openModal('{{ b.title|e }}', '{{ b.author|e }}', '{{ b.desc|e }}', '{{ b.img }}')">
            <img src="{{ b.img }}" alt="{{ b.title }}">
            <h3>{{ b.title }}</h3>
            <p><strong>{{ b.author }}</strong></p>
        </div>
        {% endfor %}
    </div>
    <button class="nav-btn" onclick="scrollC('discussed-c', 300)">❯</button>
</div>

<div style="background: #fdfaf0; margin: 80px -40px 0 -40px; padding: 60px 40px; border-top: 1px solid #f2e6c9; border-bottom: 1px solid #f2e6c9;">
    <h2 style="text-align: center; color: #5d4a27; margin-bottom: 45px; font-family: 'Georgia', serif; font-size: 2em;">
        <span style="border-bottom: 2px solid #af8c4b; padding-bottom: 10px;">Nadchodzące lektury</span>
    </h2>
    <div class="carousel-container">
        <button class="nav-btn" onclick="scrollC('upcoming-c', -300)">❮</button>
        <div class="book-carousel" id="upcoming-c">
            {% for b in upcoming %}
            <div class="card" onclick="openModal('{{ b.title|e }}', '{{ b.author|e }}', '{{ b.desc|e }}', '{{ b.img }}')">
                <img src="{{ b.img }}" alt="{{ b.title }}">
                <h3>{{ b.title }}</h3>
                <p><strong>{{ b.author }}</strong></p>
            </div>
            {% endfor %}
        </div>
        <button class="nav-btn" onclick="scrollC('upcoming-c', 300)">❯</button>
    </div>
</div>

<div id="bookModal" class="modal-overlay">
    <div class="modal-box">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="modal-img" src="" style="width: 140px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <h2 id="modal-title" style="margin: 0; color: #5d4a27; font-family: 'Georgia', serif;"></h2>
            <h4 id="modal-author" style="margin: 5px 0; color: #af8c4b; font-weight: normal; font-style: italic;"></h4>
            <p id="modal-desc" style="font-size: 0.9em; line-height: 1.5; color: #444; margin-top: 15px; text-align: justify; padding: 0 10px;"></p>
        </div>

        <hr style="border: 0; border-top: 1px solid #f2e6c9; margin: 20px 0;">

        <div style="padding: 0 10px;">
            <h3 style="color: #5d4a27; font-size: 1.1em; margin-bottom: 15px; font-family: 'Georgia', serif;">Komentarze klubowiczów</h3>
            
            <div id="modal-comments" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
                </div>

            {% if session.get('user_id') %}
                <form id="modal-comment-form" method="POST" action="">
                    <textarea name="comment_text" placeholder="Napisz swoją opinię..." 
                              style="width: 100%; height: 80px; padding: 12px; border-radius: 12px; border: 1px solid #f2e6c9; font-family: 'Georgia', serif; resize: none;" required></textarea>
                    <button type="submit" id="submit-comment-btn" 
                            style="background: #af8c4b; color: #fff; border: none; padding: 12px; border-radius: 25px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; font-family: 'Georgia', serif;">
                        Opublikuj komentarz
                    </button>
                </form>
            {% else %}
                <div style="background: #fdfaf0; padding: 20px; border-radius: 15px; text-align: center; border: 1px dashed #af8c4b;">
                    <p style="font-size: 0.95em; color: #5d4a27; margin: 0; font-family: 'Georgia', serif;">
                        Chcesz przeczytać wszystkie opinie lub dodać własną? <br>
                        <a href="{{ url_for('login') }}" style="color: #af8c4b; font-weight: bold; text-decoration: none;">Zaloguj się do klubu</a>
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function scrollC(id, d) { document.getElementById(id).scrollBy({left: d, behavior: 'smooth'}); }

    function openModal(title, author, desc, img) {
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-author').innerText = author;
    document.getElementById('modal-desc').innerText = desc;
    document.getElementById('modal-img').src = img;
    document.getElementById('bookModal').style.display = "block";
}
    
    const commDiv = document.getElementById('modal-comments');
    const form = document.getElementById('modal-comment-form');
    
    // Zabezpieczenie: czyścimy akcję formularza na start
    if(form) form.action = "#"; 
    commDiv.innerHTML = '<p style="font-size: 0.8em; color: #999;">Ładowanie rozmów...</p>';
    
    document.getElementById('bookModal').style.display = "block";

    // Używamy encodeURIComponent, żeby obsłużyć polskie znaki i apostrofy
    fetch(`/get-book-details/${encodeURIComponent(title)}`)
        .then(res => res.json())
        .then(data => {
            if(!data.error && data.id) {
                if(form) {
                    // Ustawiamy poprawny adres wysyłki komentarza
                    form.action = "/add-comment/" + data.id;
                }
                
                commDiv.innerHTML = data.comments.length ? data.comments.map(c => `
                    <div class="comment-bubble">
                        <strong style="color: #5d4a27;">${c.user}</strong> 
                        <small style="color: #999; float: right;">${c.date}</small>
                        <p style="margin: 5px 0 0 0; color: #444;">${c.text}</p>
                    </div>
                `).join('') : '<p style="font-size: 0.8em; color: #999;">Brak komentarzy. Bądź pierwszy!</p>';
            } else {
                commDiv.innerHTML = '<p style="font-size: 0.8em; color: #999;">Zaloguj się w Panelu i dodaj tę książkę do bazy, aby odblokować komentarze.</p>';
            }
        })
        .catch(err => {
            console.error("Błąd fetch:", err);
            commDiv.innerHTML = '<p>Błąd połączenia z bazą.</p>';
        });
}

    function closeModal() { document.getElementById('bookModal').style.display = "none"; }
    window.onclick = function(event) { if (event.target == document.getElementById('bookModal')) closeModal(); }

    const countDownDate = new Date("Feb 15, 2026 19:00:00").getTime();
    setInterval(function() {
        const now = new Date().getTime();
        const distance = countDownDate - now;
        if (distance < 0) return;
        document.getElementById("days").innerHTML = Math.floor(distance / (1000 * 60 * 60 * 24));
        document.getElementById("hours").innerHTML = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        document.getElementById("minutes").innerHTML = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        document.getElementById("seconds").innerHTML = Math.floor((distance % (1000 * 60)) / 1000);
    }, 1000);

</script>

<script>
    // 1. Funkcja do przewijania karuzeli (zostawiamy bez zmian)
    function scrollC(id, d) { 
        document.getElementById(id).scrollBy({left: d, behavior: 'smooth'}); 
    }

    // 2. SILNIK ZEGARA
    // Ustawiamy datę spotkania: 15 lutego 2026, godzina 19:00
    const countDownDate = new Date("Feb 15, 2026 19:00:00").getTime();

    // Aktualizacja co 1 sekundę
    const timerInterval = setInterval(function() {
        const now = new Date().getTime();
        const distance = countDownDate - now;

        // Jeśli data minęła
        if (distance < 0) {
            clearInterval(timerInterval);
            document.getElementById("timer").innerHTML = "SPOTKANIE W TRAKCIE!";
            return;
        }

        // Obliczenia dla dni, godzin, minut i sekund
        const d = Math.floor(distance / (1000 * 60 * 60 * 24));
        const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((distance % (1000 * 60)) / 1000);

        // Wstawienie liczb do Twojego HTML
        document.getElementById("days").innerHTML = d.toString().padStart(2, '0');
        document.getElementById("hours").innerHTML = h.toString().padStart(2, '0');
        document.getElementById("minutes").innerHTML = m.toString().padStart(2, '0');
        document.getElementById("seconds").innerHTML = s.toString().padStart(2, '0');
    }, 1000);
</script>


{% endblock %}